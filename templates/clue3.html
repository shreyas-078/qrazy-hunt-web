<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Clue 3: Picture Puzzle</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    html {
      font-size: 62.5%;
    }

    :root {
      /* Responsive width and height that adjusts based on screen size */
      --width: min(40vw, 500px);
      --height: min(24vw, 300px);
    }

    .container {
      height: 100vh;
      display: grid;
      place-items: center;
      background-color: #ccccf1;
      overflow: hidden;
      padding: 1rem;
    }

    .puzzle-wrapper {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 2rem;
    }

    .cells,
    .puzzle {
      width: var(--width);
      height: var(--height);
      border: 0.1rem dashed #fff;
      background-color: #bdbdf0;
      display: grid;
      grid-template-columns: repeat(5, calc(var(--width) / 5));
      grid-template-rows: repeat(4, calc(var(--height) / 4));
      position: relative;
    }

    .cells div,
    .puzzle div {
      border-right: 0.1rem dashed #fff;
      border-bottom: 0.1rem dashed #fff;
    }

    .puzzle div {
      transition: background-color 0.3s;
    }

    .puzzle div.active {
      background-color: #9898ec;
    }

    .puzzle div div {
      width: 100%;
      height: 100%;
      background-size: var(--width) var(--height);
      background-repeat: no-repeat;
      animation: dropAnim 0.5s forwards;
    }

    @keyframes dropAnim {
      0% {
        opacity: 0.5;
      }

      100% {
        opacity: 1;
      }
    }

    .cells div {
      background-size: var(--width) var(--height);
      background-repeat: no-repeat;
      position: absolute;
      width: calc(var(--width) / 5);
      height: calc(var(--height) / 4);
      cursor: grab;
    }

    .final-img {
      width: 20vw;
      background-repeat: no-repeat;
      background-position: center;
      background-size: cover;
      position: relative;
      display: none;
    }

    .btns {
      position: absolute;
      top: 70%;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      column-gap: 2rem;
      opacity: 1;
      transition: opacity 0.3s;
    }

    #input-file {
      display: none;
    }

    .btn {
      background-color: rgba(109, 161, 240, 0.588);
      padding: 1rem;
      color: #fff;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 0.1rem;
      font-weight: 500;
      border-radius: 2rem;
      cursor: pointer;
      border: 0.1rem solid #fff;
      width: max-content;
      transition: background-color 0.3s;
    }

    .btn:hover {
      background-color: rgba(109, 161, 240, 0.808);
    }

    .modal {
      position: fixed;
      inset: 0;
      background-color: rgba(44, 42, 42, 0.718);
      display: grid;
      place-items: center;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.5s;
    }

    .modal-content {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      row-gap: 1rem;
      width: min(40rem, 90vw);
      padding: 2rem;
      aspect-ratio: auto;
      background-color: #ccccf1;
      color: #333;
      border-radius: 1rem;
    }

    .modal-heading {
      font-size: clamp(2rem, 5vw, 4rem);
      text-align: center;
    }

    .modal-text {
      font-size: clamp(1.4rem, 3vw, 1.8rem);
      text-transform: uppercase;
      text-align: center;
    }

    .modal-btn {
      margin-top: 2rem;
    }

    .attempt {
      display: inline-block;
      margin-inline: 0.5rem;
      font-size: 4rem;
      color: #daa520;
    }

    .loader {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #9898ec;
      display: grid;
      place-items: center;
      opacity: 0;
      visibility: hidden;
    }

    .loader.active {
      visibility: visible;
      opacity: 1;
    }

    .loader img {
      width: 10rem;
    }

    .heading {
      position: absolute;
      right: 2rem;
      bottom: 2rem;
      font-size: 3rem;
      color: rgba(51, 51, 51, 0.365);
      text-transform: uppercase;
    }

    /* Add media queries for different screen sizes */
    @media (max-width: 768px) {
      :root {
        --width: 80vw;
        --height: 48vw;
      }

      .puzzle-wrapper {
        gap: 3rem;
      }

      .heading {
        font-size: 2rem;
        right: 1rem;
        bottom: 1rem;
      }

      .btn {
        font-size: 1rem;
        padding: 0.8rem;
      }
    }

    @media (max-width: 480px) {
      :root {
        --width: 90vw;
        --height: 54vw;
      }

      .puzzle-wrapper {
        gap: 2rem;
      }

      .heading {
        font-size: 1.5rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="puzzle-wrapper">
      <div class="cells"></div>
      <div class="puzzle"></div>
      <div class="final-img">
        <div class="upload-img">
          <div class="btns">
            <button class="img-btn btn random-btn">get random image</button>
          </div>
          <input type="file" accept="image/jpeg, image/png, image/jpg" id="input-file" />
        </div>
      </div>
    </div>
    <div class="modal">
      <div class="modal-content">
        <h2 class="modal-heading">Congratulations!</h2>
        <h3 class="modal-text">You solved the puzzle!</h3>
        <button class="modal-btn btn">Close</button>
      </div>
    </div>
    <div class="loader active">
      <img src="/static/images/match-image/loader.gif" alt="Loading..." />
    </div>
    <h1 class="heading">Clue 3: Picture Puzzle - EXTREME DIFFICULTY</h1>
  </div>

  <script type="module">
    let images = [];

    class Elements {
      constructor() {
        this.puzzle = document.querySelector('.puzzle')
        this.cellsAmount = 20
        this.puzzleDivs = []
        this.draggableDivs = []
        this.cells = document.querySelector('.cells')
        this.modal = document.querySelector('.modal')
        this.modalText = document.querySelector('.modal-text')
        this.modalBtn = document.querySelector('.modal-btn')
        this.attempt = document.querySelector('.attempt')
        this.finalImg = document.querySelector('.final-img')
        this.inputFile = document.getElementById('input-file')
        this.loader = document.querySelector('.loader')
        this.randomBtn = document.querySelector('.random-btn')
        this.createElments()
      }

      createElments() {
        for (let index = 0; index < this.cellsAmount; index++) {
          const puzzleDiv = document.createElement('div')
          puzzleDiv.setAttribute('data-index', index)
          this.puzzle.append(puzzleDiv)
          this.puzzleDivs.push(puzzleDiv)

          const draggableDiv = document.createElement('div')
          draggableDiv.setAttribute('data-index', index)
          draggableDiv.setAttribute('draggable', true)
          this.draggableDivs.push(draggableDiv)
        }
      }
    }

    async function fetchImages() {
      // Use a fixed image instead of fetching random ones
      images = [{ image: "/static/assets/image3.png" }];
      return images;
    }

    class PositionElements {
      constructor() {
        this.elements = new Elements()
        this.leftPositions = [0, 8, 16, 24, 32]
        this.topPositions = [0, 6, 12, 18]
        this.addDraggableDivs()
      }

      shuffle(array) {
        return array.sort(() => Math.random() - 0.5)
      }

      shufflePositions() {
        return this.shuffle(this.leftPositions)
          .map((leftPosition) => {
            return this.shuffle(this.topPositions).map((topPosition) => [leftPosition, topPosition])
          })
          .reduce((positions, item) => [...positions, ...item])
      }

      bgPositions() {
        return this.topPositions
          .map((topPosition) => {
            return this.leftPositions.map((leftPosition) => [topPosition, leftPosition])
          })
          .reduce((positions, item) => [...positions, ...item])
      }

      async addDraggableDivs() {
        await fetchImages();
        const { cells, draggableDivs, finalImg, loader, randomBtn } = this.elements;
        loader.classList.add('active');
        loader.classList.remove('active');

        // Always use image2.png
        const imageUrl = "/static/assets/image2.png";
        finalImg.style.backgroundImage = `url(${imageUrl})`

        const bgPositions = this.bgPositions()
        const shufflePositions = this.shufflePositions()

        draggableDivs.forEach((div, i) => {
          div.style.backgroundImage = `url(${imageUrl})`
          cells.append(div)
          div.style.backgroundPosition = `-${bgPositions[i][1]}vw -${bgPositions[i][0]}vw`
          div.style.left = `${shufflePositions[i][0]}vw`
          div.style.top = `${shufflePositions[i][1]}vw`
        })
        randomBtn.onclick = () => location.reload()
      }
    }

    class DragDrop {
      constructor() {
        this.positionElements = new PositionElements()
        this.selected = 0
        this.dragDropEvents()
        this.points = { correct: 0, wrong: 0 }
      }

      dragDropEvents() {
        const { draggableDivs, puzzleDivs, modal, modalText, modalBtn, attempt, cellsAmount } =
          this.positionElements.elements

        draggableDivs.forEach((draggableDiv, i) => {
          draggableDiv.addEventListener('dragstart', (e) => {
            this.selected = e.target
          })
          puzzleDivs[i].addEventListener('dragover', (e) => e.preventDefault())
          puzzleDivs[i].addEventListener('drop', () => {
            if (puzzleDivs[i].children.length === 0) {
              this.selected.style.top = 0
              this.selected.style.left = 0
              this.selected.style.border = 'none'
              puzzleDivs[i].append(this.selected)

              if (this.selected.dataset.index === puzzleDivs[i].dataset.index) {
                this.points.correct = 0
                puzzleDivs.forEach((div) => {
                  div.firstElementChild &&
                    div.dataset.index === div.firstElementChild.dataset.index &&
                    this.points.correct++
                })
              } else {
                this.points.wrong++
              }

              if (this.points.correct === cellsAmount) {
                modal.style.cssText = 'opacity: 1; visibility: visible;'
                document.querySelector('.modal-heading').textContent = 'Congratulations!'
                modalText.textContent = 'You solved the puzzle!'
                modalBtn.textContent = 'Close'
                modalBtn.onclick = () => {
                  modal.style.cssText = 'opacity: 0; visibility: hidden;'
                }
              } else { // Add this else statement to prevent both conditions from triggering
                const found = puzzleDivs.find((div) => !div.firstElementChild)
                if (!found && this.points.correct < cellsAmount) {
                  modal.style.cssText = 'opacity: 1; visibility: visible;'
                  document.querySelector('modal-heading').textContent = 'Uh-oh!'
                  modalText.textContent = 'You Lost. Please Try Again';
                  modalBtn.onclick = () => location.reload();
                }
              }
            }
          })
          puzzleDivs[i].addEventListener('dragenter', () => puzzleDivs[i].classList.add('active'))
          puzzleDivs[i].addEventListener('dragleave', () => puzzleDivs[i].classList.remove('active'))
        })
      }
    }

    new DragDrop();
  </script>
</body>

</html>